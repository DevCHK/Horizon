<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Risikoanalyse Dashboard</title>
<style>
:root {
  --bg: #f8f9fa;
  --text: #111;
  --card-bg: #fff;
}
[data-theme="dark"] {
  --bg: #111;
  --text: #f7f7f7;
  --card-bg: #1f1f1f;
}

body {
  margin: 0;
  font-family: sans-serif;
  background-color: var(--bg);
  color: var(--text);
  padding: 1rem;
}

h1 { font-size: 1.5rem; margin-bottom: 1rem; }

.grid { display: grid; gap: 1rem; grid-template-columns: 1fr; }
@media(min-width:600px) { .grid { grid-template-columns: 1fr 1fr; } }

.card { background-color: var(--card-bg); padding: 1rem; border-radius: 0.5rem; }
.value { font-size: 1.25rem; font-weight: bold; }
.description { font-size: 0.85rem; color: #555; }

canvas { margin-top: 0.5rem; }
</style>

<!-- Chart.js + Adapter für Zeitachse -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@4.1.3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
</head>
<body>

<h1>Risikoanalyse Dashboard</h1>
<div class="grid">
  <div class="card">
    <div>Spread (10y-2y):</div>
    <div id="spread" class="value">–</div>
    <div class="description" id="spread-date"></div>
  </div>
  <div class="card">
    <div>VIX:</div>
    <div id="vix" class="value">–</div>
    <div class="description" id="vix-date"></div>
  </div>
  <div class="card">
    <div>High Yield (bps):</div>
    <div id="hy" class="value">–</div>
    <div class="description" id="hy-date"></div>
  </div>
  <div class="card">
    <div>CAPE:</div>
    <div id="cape" class="value">–</div>
    <div class="description" id="cape-date"></div>
  </div>
  <div class="card" style="grid-column:1/-1">
    <div>Gesamteinschätzung:</div>
    <div id="overall" class="value">–</div>
    <div class="description">Grün = stabil, Gelb = Achtung, Rot = kritisch.</div>
  </div>
  <div class="card" style="grid-column:1/-1">
    <div id="last-updated" class="description"></div>
  </div>
</div>

<canvas id="combinedChart" height="400" style="margin-top:2rem"></canvas>

<script>
async function loadData() {
  try {
    const res = await fetch('data/data.json');
    const data = await res.json();
    console.log('Geladene JSON-Daten:', data);

    function colorize(value) {
      if(value==='green') return '#4ade80';
      if(value==='yellow') return '#facc15';
      if(value==='red') return '#f87171';
      return '#111';
    }

    // -------------------
    // Cards aktualisieren
    // -------------------
    const cards = [
      {id:'spread', key:'spread'},
      {id:'vix', key:'vix'},
      {id:'hy', key:'high_yield_bps'},
      {id:'cape', key:'shiller_cape'}
    ];

    cards.forEach(card => {
      const val = data[card.key]?.value;
      const date = data[card.key]?.date;
      const status = data.status?.[card.key] ?? 'unknown';

      document.getElementById(card.id).textContent = (val != null) ? val : '–';
      document.getElementById(card.id).style.color = colorize(status);
      document.getElementById(`${card.id}-date`).textContent = date ? `Datenstand: ${date}` : '';
    });

    // Gesamteinschätzung
    const overall = data.status?.overall ?? 'unknown';
    document.getElementById('overall').textContent = (overall != 'unknown') ? overall : '–';
    document.getElementById('overall').style.color = colorize(overall);

    document.getElementById('last-updated').textContent = `Letzte Aktualisierung: ${data.timestamp_utc ?? '-'}`;

    // -------------------
    // Kombiniertes Chart
    // -------------------
    const datasets = [];
    const colors = { spread:'#4ade80', vix:'#f87171', hy:'#facc15', cape:'#3b82f6' };
    const chartKeys = [
      {key:'spread', label:'Spread'},
      {key:'vix', label:'VIX'},
      {key:'high_yield_bps', label:'High Yield'},
      {key:'shiller_cape', label:'CAPE'}
    ];

    chartKeys.forEach(item => {
      const history = data[item.key]?.history ?? [];
      const value = data[item.key]?.value;

      // Nur Dataset erstellen, wenn history vorhanden und value nicht null
      if(history.length > 0 && value != null){
        const filteredHistory = history
          .filter(d => d.value != null) // keine null-Werte
          .map(d => ({x:d.date, y:d.value}));
        datasets.push({
          label: item.label,
          data: filteredHistory,
          borderColor: colors[item.key],
          backgroundColor:'rgba(0,0,0,0)',
          tension:0.3
        });
      } else {
        console.warn(`Kein Dataset für ${item.key}: history leer oder value null`);
      }
    });

    const ctx = document.getElementById('combinedChart').getContext('2d');
    if(datasets.length > 0){
      new Chart(ctx, {
        type:'line',
        data:{datasets},
        options:{
          parsing:{xAxisKey:'x',yAxisKey:'y'},
          responsive:true,
          scales:{
            x:{type:'time',time:{unit:'month'},title:{display:true,text:'Datum'}},
            y:{title:{display:true,text:'Wert'}}
          },
          plugins:{legend:{display:true,position:'top'}}
        }
      });
    } else {
      console.warn('Kein Chart dargestellt: keine validen Daten vorhanden.');
    }

  } catch(e) {
    console.error('Fehler beim Laden der Daten', e);
  }
}

// Dark Mode automatisch nach System
if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
  document.documentElement.setAttribute('data-theme','dark');
}

loadData();
</script>


</body>
</html>
